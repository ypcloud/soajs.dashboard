<script type="text/ng-template" id="deployNewService.tmpl">
	<div class="modal-header">
		<h3 class="modal-title">{{title}}</h3>
	</div>
	<div class="modal-body">
		<div class="form">
			<alert type="danger" ng-if="currentScope.message.danger">{{currentScope.message.danger}}</alert>
			<form name="deploy" id="deploy" ng-submit="deploy.$valid && onSubmit()">
				<div class="form-group">
					<div>
						<label>{{translation.serviceName[LANG]}}</label>
						<select class="form-control" ng-required="true" ng-options="service as service.name group by service.UIGroup for service in currentScope.services" ng-model="currentScope.service" ng-change="selectService(currentScope.service)"></select>
						<br>
					</div>
					<div>
						<label>{{translation.serviceVersion[LANG]}}</label>
						<select class="form-control" ng-required="true" ng-options="version as version for version in currentScope.versions" ng-model="currentScope.version"></select>
						<br>
					</div>
					<div ng-if="currentScope.groupConfigs">
						<label>{{translation.daemonGroupConfig[LANG]}}</label>
						<select class="form-control" ng-required="true" ng-options="group as group.daemonConfigGroup for group in currentScope.groupConfigs" ng-model="currentScope.groupConfig"></select>
						<br>
					</div>
					<div ng-if="(currentScope.loadingBranches || currentScope.branches) && currentScope.service.type !== 'nginx'">
						<label>{{translation.branch[LANG]}}</label><img class="loadingImage" ng-src={{imagePath}} ng-if="currentScope.loadingBranches">
						<select class="form-control" ng-required="true" ng-options="branch as branch.name for branch in currentScope.branches" ng-model="currentScope.branch" ng-change="selectBranch(currentScope.branch)"></select>
						<br>
					</div>
					<div>
						<label>Image Prefix</label>
						<input type="text" class="form-control" ng-required="true" ng-model="currentScope.imagePrefix" />
						<label class="fieldMsg">The default image that will be used is soajsorg/soajs. Specify a different prefix if you intend to use a custom image</label>
						<br />
					</div>
					<div ng-if="currentScope.service.type === 'nginx'">
						<label>Exposed Port</label>
						<input type="number" class="form-control" ng-required="false" ng-model="currentScope.exposedPort" />
						<br />
					</div>
					<div ng-if="currentScope.conflict">
						<label ng-style="{'color': 'red'}">{{translation.warning[LANG]}}</label><br>
						<label>{{translation.serviceHasRunningInstancesDifferentCommits[LANG]}}</label><br>
						<label>{{translation.recommendedToMaintainHomogeneity[LANG]}}</label><br>

						<div class="grid externalKeysGrid">
							<table cellspacing="0" cellpadding="0" border="0" width="100%" class="">
								<tbody>
									<tr>
										<th colspan="1"></th>
										<th>{{translation.commit[LANG]}}</th>
										<th>{{translation.branch[LANG]}}</th>
										<th>{{translation.hostnames[LANG]}}</th>
									</tr>
									<tr ng-repeat="(commit, data) in currentScope.conflictCommits" ng-class-even="'even'" ng-class-odd="'odd'" ng-class="{'first': $first, 'last': $last}">
										<td>
											<input type="radio" ng-if="!currentScope.confirmBranch" value="{{commit}}" ng-model="currentScope.commit">
										</td>
										<td>{{commit}}</td>
										<td>{{data.branch}}</td>
										<td>
											<span ng-repeat="instance in data.instances">{{instance.ip}} v.{{instance.version}}<br></span>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<label><input type="checkbox" value="true" ng-model="currentScope.confirmBranch" ng-click="confirmBranchSelection()">&nbsp;&nbsp;{{translation.understandTheRiskToDeploy[LANG]}}</label><br>
						<br>
					</div>
					<div ng-if="currentScope.service.type !== 'nginx'">
						<label>Replica Count</label>
						<input type="number" class="form-control" ng-model="currentScope.replicaCount" ng-required="true" />
						<br>
					</div>
					<div>
						<label>Memory Limit Per Instance (in MBytes)</label>
						<input type="number" class="form-control" ng-model="currentScope.memoryLimit" ng-required="true" />
						<br>
					</div>
					<div ng-if="currentScope.service.type !== 'nginx'">
						<label><input type="checkbox" ng-model="currentScope.useLocalSOAJS" ng-value-true="true" ng-value-false="false" />&nbsp;Enable SOAJS accelerated deployment</label>
						<br><br>
					</div>
					<div ng-if="currentScope.service.type !== 'nginx'">
						<label>{{translation.envVariables[LANG]}}</label>
						<textarea class="form-control" rows="5" ng-model="currentScope.envVariables" ng-required="false"></textarea>
						<br>
						<label>{{translation.defaultEnvVariables[LANG]}}</label>

						<div ng-bind-html="currentScope.defaultEnvVariables"></div>
						<br>
					</div>
				</div>
			</form>
		</div>
	</div>
	<div class="modal-footer">
		<button class="btn btn-primary" ng-click="onSubmit()">Deploy</button>
		<button class="btn btn-danger" ng-click="closeModal()">Cancel</button>
	</div>
</script>

<script type="text/ng-template" id="scaleService.tmpl">
	<div class="modal-header">
		<h3 class="modal-title">{{title}}</h3>
	</div>
	<div class="modal-body text-align-center">
		<div class="form">
			<label>This service is currently running as a replica of {{service.currentScale}} instance(s)</label>
			<br />
			<label>How many instances should this service be scaled to?</label>
			<input type="number" class="form-control centeredInput" required="true" ng-model="service.newScale" />
			<br />
			<alert type="info" class="text-align-center">
				Scaling a service is a process that might take some time to complete.
			</alert>
		</div>
	</div>
	<div class="modal-footer">
		<button class="btn btn-primary" ng-click="onSubmit()">Scale</button>
		<button class="btn btn-danger" ng-click="closeModal()">Cancel</button>
	</div>
</script>

<script type="text/ng-template" id="logBox.html">
	<div class="modal-header">
		<table width="100%">
			<tr>
				<td width="80%">
					<h3 class="modal-title">{{title}}</h3>
				</td>
				<td width="20%" align="center">
					<span><text-size-slider min="10" max="36" unit="px" value="12" idt="code"></text-size-slider></span>
				</td>
			</tr>
		</table>
	</div>
	<div class="modal-body">
		<pre id="code" class="preBox" scroll-glue><code style="white-space: pre !important;" class="sh">{{data}}</code></pre>
	</div>
	<div class="modal-footer">
		<button class="btn btn-primary" ng-click="ok()">{{translation.ok[LANG]}}</button>
	</div>
</script>

<section ng-controller="hacloudCtrl">
    <tabset>
        <tab heading="Nodes" ng-if="access.hacloud.nodes.list">
			<br />
			<div ng-if="localDeployment">
				<alert type="info">
					Node management is not supported in local deployment mode
				</alert>
				<br />
			</div>
			<div ng-if="!localDeployment">
				<div ng-if="envCode === 'DASHBOARD'">
		            <button class="btn btn-primary" ng-if="access.hacloud.nodes.add" ng-click="addNode()">Add New Node</button>
		            <br /><br />
				</div>
				<div ng-if="envCode !== 'DASHBOARD'">
					<alert type="info">
						Node management is only allowed in the DASHBOARD environment
					</alert>
					<br />
				</div>
			</div>
            <div class="entryBoxes">
                <div ng-repeat="node in nodes.list" class="entryBox mb20">
                    <div class="header">
                        {{node.name}}
                        <span class="rightActions" ng-if="envCode === 'DASHBOARD' && !localDeployment">
                            <a href="" ng-if="access.hacloud.nodes.remove" ng-confirm-click="Are you sure you want to remove this node?" ng-click="removeNode(node.id)">
                                <span class="icon icon-cross" tooltip="Remove Node"></span>
                            </a>
							<div ng-if="envPlatform === 'docker'">
								<a ng-if="node.role === 'manager' && access.hacloud.nodes.update" href="" ng-click="updateNode(node, 'role', 'worker')">
	                                <span class="icon icon-arrow-down2" tooltip="Demote To Worker"></span>
	                            </a>
	                            <a ng-if="node.role === 'worker' && access.hacloud.nodes.update" href="" ng-click="updateNode(node, 'role', 'manager')">
	                                <span class="icon icon-arrow-up2" tooltip="Promote To Manager"></span>
	                            </a>
							</div>
                            <a ng-if="node.availability === 'drain' && access.hacloud.nodes.update" href="" ng-click="updateNode(node, 'availability', 'active')">
                                <span class="icon icon-switch" tooltip="Activate"></span>
                            </a>
                            <a ng-if="node.availability === 'active' && access.hacloud.nodes.update" href="" ng-click="updateNode(node, 'availability', 'drain')">
                                <span class="icon icon-power-cord" tooltip="Drain"></span>
                            </a>
                        </span>
                    </div>
                    <div class="body">
                        <div class="grid">
                            <table cellspacing="0" cellpadding="0" border="1" width="100%" class="customTable">
                                <thead>
                                    <tr class="header">
                                        <td>IP Address</td>
                                        <td>{{envPlatform|capitalizeFirst}} Port</td>
                                        <td>Role</td>
                                        <td>Availability</td>
                                        <td>Memory Resources</td>
                                        <td>CPU Count</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{node.ip}}</td>
                                        <td ng-if="envPlatform === 'docker'">{{node.dockerPort}}</td>
										<td ng-if="envPlatform === 'kubernetes'">{{node.kubePort}}</td>
                                        <td>{{node.role}}</td>
                                        <td>{{node.availability}}</td>
                                        <td>{{node.resources.memory | bytesToGbytes}} GB</td>
                                        <td>{{node.resources.cpuCount}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </tab>
        <tab heading="Services" ng-if="access.listHosts">
            <br />
            <div ng-if="!hosts.controller && (!nginxHosts || nginxHosts.length === 0)">
				<div ng-if="!isDeploying">
					<alert type="warning" ng-style="{'text-align': 'center'}">
	                    This environment has not been deployed yet!
	                </alert>
	                <br />
	                <button ng-style="{'margin-left': '44%'}" ng-if="access.hacloud.services.add" class="btn btn-primary" ng-click="deployNewEnv()">Deploy Environment</button>
				</div>
                <div ng-if="isDeploying">
					<alert type="success" ng-style="{'text-align': 'center'}">
	                    This environment is being deployed and will be available in a few minutes. Please wait.
	                </alert>
				</div>
            </div>
            <div ng-if="hosts.controller || (nginxHosts && nginxHosts.length > 0)">
                <button class="btn btn-primary" ng-if="access.hacloud.services.add" ng-click="deployNewService()">Deploy New Service</button>
                <button class="btn btn-primary f-right" ng-click="listServices()" ng-if="access.listHosts"><span class="icon icon-loop2"></span>&nbsp;Refresh</button>
                <br /><br />
				<fieldset class="groupFieldset" ng-if="nginxHosts && nginxHosts.length > 0">
					<legend>
                        <a href="" class="icon" ng-class="{'icon-minus': showNginxHosts, 'icon-plus': !showNginxHosts}" ng-click="showHideContent('nginx')"></a>
                        Nginx Instances
                    </legend>
					<div class="entryBoxes" ng-show="showNginxHosts">
						<div class="entryBox mb20">
							<div class="header">
								<span class="serviceLabelBox">Nginx</span>
								<div class="dropdown serviceOpsDropdown">
									<button class="btn btn-default dropdown-toggle" type="button" id="serviceOpsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
										Service Operations
										<span class="caret"></span>
									</button>
									<ul class="dropdown-menu" aria-labelledby="serviceOpsDropdown">
										<li>&nbsp;Deployment</li>
										<li><a href="" ng-if="access.hacloud.services.scale" ng-click="scaleService(nginxHosts)"><span class="icon icon-enlarge"></span>&nbsp;Scale Service</a></li>
										<li><a href="" ng-if="access.hacloud.services.delete" ng-click="deleteService(nginxHosts[0].serviceName)"><span class="icon icon-cross"></span>&nbsp;Delete Service</a></li>
									</ul>
								</div>
							</div>
							<div class="body">
								<div class="grid">
									<table cellspacing="0" cellpadding="0" border="1" width="100%" class="customTable">
										<thead>
											<tr class="header">
												<td class="maintenanceHeader">Maintenance</td>
												<td class="hostnameHeader">Hostname</td>
												<td class="statusHeader">Status</td>
												<td ng-if="envPlatform === 'docker'" class="ipHeader">IP Address</td>
											</tr>
										</thead>
										<tbody>
											<tr ng-repeat="instance in nginxHosts">
												<td>
													<a href="" ng-if="access.hacloud.services.logs">
														<span ng-click="hostLogs(instance.taskName)" class="icon icon-terminal" title="{{translation.getContainerLogs[LANG]}}"></span>
													</a>
												</td>
												<td>{{instance.taskName}}</td>
												<td>
													<span style="color: green" ng-if="instance.running"><b>Healthy</b></span>
													<span style="color: red" ng-if="!instance.running"><b>Unreachable</b></span>
												</td>
												<td ng-if="envPlatform === 'docker'">{{instance.networkInfo.ip}}</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</fieldset>
                <fieldset class="groupFieldset" ng-if="hosts.controller">
                    <legend>
                        <a href="" class="icon" ng-class="{'icon-minus': showCtrlHosts, 'icon-plus': !showCtrlHosts}" ng-click="showHideContent('controller')"></a>
                        SOAJS Controllers
                    </legend>
                    <div ng-repeat="(serviceName, serviceInfo) in hosts">
                        <div ng-if="serviceName === 'controller'" ng-show="showCtrlHosts">
                            <div class="entryBoxes">
                                <div class="entryBox mb20">
                                    <div class="header">
                                        <span class="serviceLabelBox">{{serviceName|uppercase}} - v.{{oneIp.version}} | Port: {{serviceInfo.port}}</span>
                                        <div class="dropdown serviceOpsDropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button" id="serviceOpsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                Service Operations
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="serviceOpsDropdown">
                                                <li>&nbsp;Deployment</li>
                                                <li><a href="" ng-if="access.hacloud.services.scale" ng-click="scaleService(serviceInfo.ips)"><span class="icon icon-enlarge"></span>&nbsp;Scale Service</a></li>
                                                <li><a href="" ng-if="access.hacloud.services.delete" ng-click="deleteService(serviceInfo.ips[0].serviceName)"><span class="icon icon-cross"></span>&nbsp;Delete Service</a></li>
                                                <li>&nbsp;Maintenance</li>
                                                <li><a href="" ng-click="reloadServiceRegistry('controller', serviceInfo.ips)"><span class="icon icon-undo"></span>&nbsp;Reload Registry</a></li>
                                                <li><a href="" ng-click="awarenessStat('controller', serviceInfo.ips)"><span class="icon icon-connection"></span>&nbsp;Awareness Stat</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="body">
                                        <div class="grid">
                                            <table cellspacing="0" cellpadding="0" border="1" width="100%" class="customTable">
                                                <thead>
                                                    <tr class="header">
                                                        <td class="maintenanceHeader">Maintenance</td>
                                                        <td class="hostnameHeader">Hostname</td>
                                                        <td class="statusHeader">Status</td>
                                                        <td class="ipHeader">IP Address</td>
                                                        <td>Code</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr ng-repeat="container in serviceInfo.ips">
                                                        <td>
                                                            <a href="" ng-click="executeHeartbeatTest(envCode, container)" title="{{translation.executeHeartbeatOperation[LANG]}}">
                                                                <span class="icon icon-heart"></span>&nbsp;
                                                            </a>

                                                            <a href="" ng-if="access.hacloud.services.logs" ng-show="container.taskName" ng-click="hostLogs(container.taskName)">
                                                                <span class="icon icon-terminal" title="{{translation.getContainerLogs[LANG]}}"></span>&nbsp;
                                                            </a>
                                                        </td>
                                                        <td>{{container.taskName}}</td>
                                                        <td>
                                                            <span style="color: green" ng-if="container.heartbeat"><b>Healthy</b></span>
                                                            <span style="color: red" ng-if="!container.heartbeat"><b>Unreachable</b></span>
                                                        </td>
                                                        <td>{{container.ip}}</td>
                                                        <td>{{container.code}}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <div ng-repeat="(groupName, groupContent) in groups">
                    <fieldset class="groupFieldset">
                        <legend>
                            <a href="" class="icon" ng-class="{'icon-minus': groupContent.showContent, 'icon-plus': !groupContent.showContent}" ng-click="showHideGroupContent(groupName)"></a>{{groupName}}
                        </legend>
                        <div class="entryBoxes">
                            <div ng-repeat="service in groupContent.services" ng-if="groupContent.showContent">
								<div class="entryBox mb20" ng-repeat="(version, versionInfo) in hosts[service].ips">
									<div class="header">
	                                    <span class="serviceLabelBox">{{hosts[service].name|uppercase}} - v.{{version}} | Port: {{hosts[service].port}}</span>
	                                    <div class="dropdown serviceOpsDropdown">
	                                        <button class="btn btn-default dropdown-toggle" type="button" id="serviceOpsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
	                                            Service Operations
	                                            <span class="caret"></span>
	                                        </button>
	                                        <ul class="dropdown-menu" aria-labelledby="serviceOpsDropdown">
	                                            <li>&nbsp;Deployment</li>
	                                            <li><a href="" ng-if="access.hacloud.services.scale" ng-click="scaleService(versionInfo, version)"><span class="icon icon-enlarge"></span>&nbsp;Scale Service</a></li>
	                                            <li><a href="" ng-if="access.hacloud.services.delete" ng-click="deleteService(versionInfo[0].serviceName, version)"><span class="icon icon-cross"></span>&nbsp;Delete Service</a></li>
	                                            <li>&nbsp;Maintenance</li>
	                                            <li><a href="" ng-click="reloadServiceRegistry('service', versionInfo)"><span class="icon icon-undo"></span>&nbsp;Reload Registry</a></li>
	                                            <li><a href="" ng-click="loadServiceProvision('service', versionInfo)"><span class="icon icon-download3"></span>&nbsp;Load Provision</a></li>
	                                        </ul>
	                                    </div>
	                                </div>
	                                <div class="body">
	                                    <div class="grid">
	                                        <table cellspacing="0" cellpadding="0" border="1" width="100%" class="customTable">
	                                            <thead>
	                                                <tr class="header">
	                                                    <td class="maintenanceHeader">Maintenance</td>
	                                                    <td class="hostnameHeader">Hostname</td>
	                                                    <td class="statusHeader">Status</td>
	                                                    <td class="ipHeader">IP Address</td>
	                                                    <td>Controller Awareness</td>
	                                                </tr>
	                                            </thead>
	                                            <tbody>
	                                                <tr ng-repeat="container in versionInfo">
	                                                    <td>
	                                                        <a href="" ng-click="executeHeartbeatTest(envCode, container)" title="{{translation.executeHeartbeatOperation[LANG]}}">
	                                                            <span class="icon icon-heart"></span>&nbsp;
	                                                        </a>

	                                                        <a href="" ng-show="container.healthy && hosts[service].type === 'daemon'" ng-click="loadDaemonStats(envCode, container)" title="{{translation.loadDaemonStatisticsOperation[LANG]}}">
	                                                            <span class="icon icon-stats-dots"></span>&nbsp;
	                                                        </a>

	                                                        <a href="" ng-if="access.hacloud.services.logs" ng-show="container.taskName" ng-click="hostLogs(container.taskName)">
	                                                            <span class="icon icon-terminal" title="{{translation.getContainerLogs[LANG]}}"></span>&nbsp;
	                                                        </a>
	                                                    </td>
	                                                    <td>{{container.taskName}}</td>
	                                                    <td>
	                                                        <span style="color: green" ng-if="container.healthy"><b>Healthy</b></span>
	                                                        <span style="color: red" ng-if="!container.healthy"><b>Unreachable</b></span>
	                                                    </td>
	                                                    <td>{{container.ip}}</td>
	                                                    <td>
	                                                        <span ng-repeat="ctrl in container.controllers" class="ctrlBox" ng-class="{'ctrlBoxHealthy': ctrl.heartbeat, 'ctrlBoxUnhealthy': !ctrl.heartbeat}">{{ctrl.code}}</span>
	                                                    </td>
	                                                </tr>
	                                            </tbody>
	                                        </table>
	                                    </div>
	                                </div>
								</div>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </tab>
    </tabset>
</section>
